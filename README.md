# Space-capsule 太空舱计划

## Info

太空舱计划基于标准化错误定界和定位的理念设计，能够快速的帮助用户在传统集群或K8s集群中构造异常场景，并记录异常发生的一系列原因。

已经有许多出色的故障注入程序，他们能够基于tc或dd等常用工具，对用户主机进行资源和网络的干预，以验证程序的健壮性。

我们的目的是对这些故障注入程序进行进一步的封装，来切换我们看待问题的角度。

- 当用户的程序出现某种异常时，如网页加载异常，它可能是网络故障，也可能是调用链上的某个节点死锁
- 一个运行良好的监控工具应该能够检测到用户程序出现的异常，并对问题发生的原因进行定界和定位
- 为此，我们提供一个工具，对于指定的异常表现，从导致该表现的常见原因中随机选择一种，使用户程序发生该异常表现。来验证监控工具的检测和定界能力

用户可以在异常环境中自行部署需要验证的探针，以评估待测试的监控工具在预设异常场景下的探测能力。

## 能力

- 基于命令行工具，快速构建实验环境。

- 罗列常见的问题场景和导致问题的原因

- 通过注入程序快速复现用户异常场景，并支持快速恢复

- 复现指定原因导致的问题场景

## 工作流程

1. 协助用户准备好实验环境
2. 列出支持的用户异常表现
3. 根据用户选择的异常表现，设计会导致该异常的实验脚本
4. 执行脚本，造成用户异常
5. 将监控工具检测和定位到的问题原因和真实原因进行对比，以覆盖该场景下，探针的排错能力
6. 将实验环境恢复至注入缺陷前的状态

## 缺陷注入

- [x] 支持出网和入网流量延迟和丢包场景，支持以下粒度: node,workload,pod,containers
- [x] 支持资源抢占场景，包括 cpu，mem和disk资源, 支持以下粒度: node,workload,pod,containers
- [x] 支持k8s资源限制场景，包括cpu，memory和ephemeral storage的requests，limit限制
- [ ] 支持Java应用程序异常场景，包括死锁，资源异常使用，RuntimeError, 外部资源阻塞等情况

## 预构建缺陷场景和原因

- 服务应用响应慢（实施中）
  - [x] 节点/Pod网络异常： 服务应用所在主机和客户端节点之间存在网络访问异常，如过久的延时；tcp连接中断导致的请求丢失等情况
  - [x] K8s资源配额不合理： 服务应用各类k8s资源（cpu，mem，storage）limit不能满足服务的工作负载需求
  - [x] 节点资源紧缺： 服务应用所在主机负载过重，缺少充足的资源提供给服务应用用于请求处理
  - [ ] 外部资源异常： 服务处理当前请求时依赖的外部资源异常，如Sql语句执行时间过久，调用链的后续节点响应慢
  - [ ] 应用程序代码缺陷： 请求经过了低效且长耗时的业务代码
- 服务应用错误返回 （待开展）
  - [ ] 应用程序网络异常：由防火墙导致的tcp链接超时断，服务路由端口未能正确匹配等
  - [ ] 应用程序代码缺陷： 代码中存在未处理的程序缺陷，如未捕获的异常引发致命终止；程序存在死锁等
  - [ ] 应用程序资源异常： 常见如JVM内存超出限
  - [ ] 访问权限控制：来自网关或反向代理服务器要求的身份认证等信息
  - [ ] 外部资源异常： 常见如Sql执行时间超时，调用链的后续节点响应超时/异常
- 服务应用无法连接 （待开展）
  - [ ] 容器连接数限制： 容器连接数超过系统预设最大文件打开数
  - [ ] 容器网络策略： 容器仅能根据提供的网络策略访问有限的资源
  - [ ] 服务应用未能创建实例： 常见如命名空间资源配额限制，节点资源紧缺
  - [ ] 域名解析失败： 常见如DNS污染，k8s-svc资源创建/匹配异常
  - [ ] 节点/Pod网络异常： 服务应用所在主机和其他工作节点之间存在网络访问异常，如过久的延时，丢包；k8s基础网络服务故障，如calico异常，ip分配策略错误等
  
